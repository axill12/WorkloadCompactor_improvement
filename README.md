It works almost always. Now it does not stick in lock of else. I fixed also an issue which happened when one thread increases the totalWorkOfTwoRequests and then the other thread checks the condition counterForThisPacket == packetsCounter[0] of if before the other thread increases packetsCounter[0]. In this case, if the two requests arrive at the same moment it is wrong to assign all tokens to it. That is why i wrote if (work < totalWorkOfTwoRequests)'s block. Moreover if two requests arrive at the same time it splits the tokens according to the amount of work of its requests. Specifically it gives to request r1 with a1 amount of work tokens depending on a1 / a1 + a2. a2 is the amount of work of the other request. The closer fraction is to 1 the more tokens it assignes. The rest tokens are assigned to the other request.
